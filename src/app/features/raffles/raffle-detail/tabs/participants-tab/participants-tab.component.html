<div class="participants-tab">

  <!-- ==================== STATS PANEL ==================== -->
  @if (stats(); as participantStats) {
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-icon users">
          <i class="fas fa-users"></i>
        </div>
        <div class="stat-content">
          <span class="stat-value">{{ participantStats.total }}</span>
          <span class="stat-label">Participantes</span>
        </div>
      </div>

      <div class="stat-card">
        <div class="stat-icon tickets">
          <i class="fas fa-ticket-alt"></i>
        </div>
        <div class="stat-content">
          <span class="stat-value">{{ participantStats.totalTickets }}</span>
          <span class="stat-label">Total Boletos</span>
        </div>
      </div>

      <div class="stat-card">
        <div class="stat-icon money">
          <i class="fas fa-dollar-sign"></i>
        </div>
        <div class="stat-content">
          <span class="stat-value">{{ participantStats.totalPaid | currency:'MXN':'symbol':'1.0-0' }}</span>
          <span class="stat-label">Total Pagado</span>
        </div>
      </div>

      <div class="stat-card">
        <div class="stat-icon paid">
          <i class="fas fa-check-circle"></i>
        </div>
        <div class="stat-content">
          <span class="stat-value">{{ participantStats.withPayments }}</span>
          <span class="stat-label">Con Pagos</span>
        </div>
      </div>
    </div>
  }

  <!-- ==================== TOOLBAR ==================== -->
  <div class="toolbar">
    <div class="filters">
      <!-- Search -->
      <div class="search-box">
        <i class="fas fa-search"></i>
        <input 
          type="text" 
          placeholder="Buscar por nombre, teléfono o email..."
          [value]="searchTerm()"
          (input)="searchTerm.set($any($event.target).value)">
      </div>

      <!-- Sort -->
      <div class="sort-controls">
        <button 
          class="sort-btn"
          [class.active]="sortBy() === 'name'"
          (click)="setSorting('name')">
          <i class="fas fa-sort-alpha-down"></i>
          Nombre
          @if (sortBy() === 'name') {
            <i class="fas" [class.fa-sort-up]="sortOrder() === 'asc'" [class.fa-sort-down]="sortOrder() === 'desc'"></i>
          }
        </button>
        <button 
          class="sort-btn"
          [class.active]="sortBy() === 'tickets'"
          (click)="setSorting('tickets')">
          <i class="fas fa-ticket-alt"></i>
          Boletos
          @if (sortBy() === 'tickets') {
            <i class="fas" [class.fa-sort-up]="sortOrder() === 'asc'" [class.fa-sort-down]="sortOrder() === 'desc'"></i>
          }
        </button>
        <button 
          class="sort-btn"
          [class.active]="sortBy() === 'amount'"
          (click)="setSorting('amount')">
          <i class="fas fa-dollar-sign"></i>
          Monto
          @if (sortBy() === 'amount') {
            <i class="fas" [class.fa-sort-up]="sortOrder() === 'asc'" [class.fa-sort-down]="sortOrder() === 'desc'"></i>
          }
        </button>
        <button 
          class="sort-btn"
          [class.active]="sortBy() === 'date'"
          (click)="setSorting('date')">
          <i class="fas fa-calendar"></i>
          Fecha
          @if (sortBy() === 'date') {
            <i class="fas" [class.fa-sort-up]="sortOrder() === 'asc'" [class.fa-sort-down]="sortOrder() === 'desc'"></i>
          }
        </button>
      </div>
    </div>

    <div class="actions">
      <button class="btn btn-outline" (click)="loadParticipants()">
        <i class="fas fa-sync"></i>
        Actualizar
      </button>
      <button class="btn btn-outline" (click)="exportParticipants()">
        <i class="fas fa-download"></i>
        Exportar
      </button>
    </div>
  </div>

  <!-- ==================== LOADING ==================== -->
  @if (isLoading()) {
    <div class="loading-state">
      <div class="spinner"></div>
      <p>Cargando participantes...</p>
    </div>
  }

  <!-- ==================== ERROR ==================== -->
  @if (error()) {
    <div class="error-state">
      <i class="fas fa-exclamation-triangle"></i>
      <p>{{ error() }}</p>
      <button class="btn btn-primary" (click)="loadParticipants()">
        Reintentar
      </button>
    </div>
  }

  <!-- ==================== PARTICIPANTS GRID ==================== -->
  @if (!isLoading() && !error()) {
    @if (filteredParticipants().length > 0) {
      <div class="participants-grid">
        @for (participant of filteredParticipants(); track participant.buyerPhone) {
          <div class="participant-card" (click)="viewParticipantDetail(participant)">
            <!-- Avatar -->
            <div class="participant-avatar">
              <i class="fas fa-user"></i>
            </div>

            <!-- Info -->
            <div class="participant-info">
              <h3 class="participant-name">
                {{ participant.buyerFirstName }} {{ participant.buyerLastName }}
              </h3>
              
              <div class="participant-contact">
                <span class="phone">
                  <i class="fas fa-phone"></i>
                  {{ participant.buyerPhone }}
                </span>
                @if (participant.buyerEmail) {
                  <span class="email">
                    <i class="fas fa-envelope"></i>
                    {{ participant.buyerEmail }}
                  </span>
                }
              </div>
            </div>

            <!-- Stats -->
            <div class="participant-stats">
              <div class="stat-item">
                <span class="stat-icon tickets">
                  <i class="fas fa-ticket-alt"></i>
                </span>
                <div class="stat-details">
                  <span class="stat-value">{{ participant.totalTickets }}</span>
                  <span class="stat-label">Boletos</span>
                </div>
              </div>

              <div class="stat-item">
                <span class="stat-icon money">
                  <i class="fas fa-dollar-sign"></i>
                </span>
                <div class="stat-details">
                  <span class="stat-value">{{ participant.totalPaid | currency:'MXN':'symbol':'1.0-0' }}</span>
                  <span class="stat-label">Pagado</span>
                </div>
              </div>
            </div>

            <!-- Status -->
            <div class="participant-status">
              <span class="status-badge" [ngClass]="getStatusClass(participant)">
                {{ getParticipantStatus(participant) }}
              </span>
            </div>

            <!-- Arrow -->
            <div class="participant-arrow">
              <i class="fas fa-chevron-right"></i>
            </div>
          </div>
        }
      </div>
    } @else {
      <div class="empty-state">
        <i class="fas fa-users"></i>
        <h3>No hay participantes</h3>
        <p>No se encontraron participantes con los filtros seleccionados</p>
      </div>
    }
  }

  <!-- ==================== DETAIL MODAL ==================== -->
  @if (showDetailModal() && selectedParticipant(); as participant) {
    <div class="modal-overlay" (click)="closeDetailModal()">
      <div class="modal-content" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h3>Detalle del Participante</h3>
          <button class="btn-close" (click)="closeDetailModal()">
            <i class="fas fa-times"></i>
          </button>
        </div>

        <div class="modal-body">
          <!-- Participant info -->
          <div class="detail-section">
            <h4><i class="fas fa-user"></i> Información Personal</h4>
            <div class="info-grid">
              <div class="info-item">
                <span class="label">Nombre:</span>
                <span class="value">{{ participant.buyerFirstName }} {{ participant.buyerLastName }}</span>
              </div>
              <div class="info-item">
                <span class="label">Teléfono:</span>
                <span class="value">{{ participant.buyerPhone }}</span>
              </div>
              @if (participant.buyerEmail) {
                <div class="info-item">
                  <span class="label">Email:</span>
                  <span class="value">{{ participant.buyerEmail }}</span>
                </div>
              }
              <div class="info-item">
                <span class="label">Ubicación:</span>
                <span class="value">{{ participant.state }}, {{ participant.country }}</span>
              </div>
            </div>
          </div>

          <!-- Tickets stats -->
          <div class="detail-section">
            <h4><i class="fas fa-chart-bar"></i> Estadísticas</h4>
            <div class="stats-grid-modal">
              <div class="stat-box">
                <span class="stat-label">Total Boletos</span>
                <span class="stat-value">{{ participant.totalTickets }}</span>
              </div>
              <div class="stat-box">
                <span class="stat-label">Boletos Pagados</span>
                <span class="stat-value">{{ participant.paidTickets }}</span>
              </div>
              <div class="stat-box">
                <span class="stat-label">Boletos Reservados</span>
                <span class="stat-value">{{ participant.reservedTickets }}</span>
              </div>
              <div class="stat-box">
                <span class="stat-label">Total Pagado</span>
                <span class="stat-value">{{ participant.totalPaid | currency:'MXN' }}</span>
              </div>
            </div>
          </div>

          <!-- Tickets list -->
          <div class="detail-section">
            <h4><i class="fas fa-ticket-alt"></i> Boletos ({{ participant.tickets.length }})</h4>
            <div class="tickets-list">
              @for (ticket of participant.tickets; track ticket) {
                <span class="ticket-number">{{ ticket }}</span>
              }
            </div>
          </div>

          <!-- Payments -->
          @if (participant.payments.length > 0) {
            <div class="detail-section">
              <h4><i class="fas fa-receipt"></i> Pagos ({{ participant.payments.length }})</h4>
              <div class="payments-list">
                @for (payment of participant.payments; track payment.paymentId) {
                  <div class="payment-item">
                    <div class="payment-info">
                      <span class="payment-amount">{{ payment.amount | currency:'MXN' }}</span>
                      <span class="payment-date">{{ payment.createdAt | date:'dd/MM/yyyy HH:mm' }}</span>
                    </div>
                    <span class="payment-status" [ngClass]="'status-' + payment.status.toLowerCase()">
                      {{ payment.status }}
                    </span>
                  </div>
                }
              </div>
            </div>
          }

          <!-- Timeline -->
          <div class="detail-section">
            <h4><i class="fas fa-history"></i> Historial</h4>
            <div class="timeline">
              <div class="timeline-item">
                <div class="timeline-icon">
                  <i class="fas fa-shopping-cart"></i>
                </div>
                <div class="timeline-content">
                  <span class="timeline-label">Primera compra</span>
                  <span class="timeline-date">{{ participant.firstPurchase | date:'dd/MM/yyyy HH:mm' }}</span>
                </div>
              </div>
              <div class="timeline-item">
                <div class="timeline-icon">
                  <i class="fas fa-clock"></i>
                </div>
                <div class="timeline-content">
                  <span class="timeline-label">Última compra</span>
                  <span class="timeline-date">{{ participant.lastPurchase | date:'dd/MM/yyyy HH:mm' }}</span>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="modal-footer">
          <button class="btn btn-outline" (click)="closeDetailModal()">
            Cerrar
          </button>
        </div>
      </div>
    </div>
  }

</div>